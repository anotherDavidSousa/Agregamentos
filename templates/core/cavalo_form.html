{% extends 'base.html' %}

{% block title %}{% if form_type == 'create' %}Novo Cavalo{% else %}Editar Cavalo{% endif %}{% endblock %}

{% block content %}
<h2>{% if form_type == 'create' %}Novo Cavalo{% else %}Editar Cavalo{% endif %}</h2>

<form method="post" enctype="multipart/form-data">
    {% csrf_token %}
    
    <div class="form-group">
        <label for="placa">Placa</label>
        <input type="text" id="placa" name="placa" 
               value="{% if cavalo %}{{ cavalo.placa }}{% endif %}">
    </div>
    
    <div class="form-group">
        <label for="ano">Ano</label>
        <input type="number" id="ano" name="ano" 
               value="{% if cavalo %}{{ cavalo.ano }}{% endif %}">
    </div>
    
    <div class="form-group">
        <label for="cor">Cor</label>
        <input type="text" id="cor" name="cor" 
               value="{% if cavalo %}{{ cavalo.cor }}{% endif %}">
    </div>
    
    <div class="form-group">
        <label for="fluxo">Fluxo</label>
        <select id="fluxo" name="fluxo">
            <option value="">Selecione...</option>
            <option value="escoria" {% if cavalo and cavalo.fluxo == 'escoria' %}selected{% endif %}>Escória</option>
            <option value="minerio" {% if cavalo and cavalo.fluxo == 'minerio' %}selected{% endif %}>Minério</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="tipo">Tipo</label>
        <select id="tipo" name="tipo">
            <option value="">Selecione...</option>
            <option value="bi_truck" {% if cavalo and cavalo.tipo == 'bi_truck' %}selected{% endif %}>Bi-truck</option>
            <option value="toco" {% if cavalo and cavalo.tipo == 'toco' %}selected{% endif %}>Toco</option>
            <option value="trucado" {% if cavalo and cavalo.tipo == 'trucado' %}selected{% endif %}>Trucado</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="classificacao">Classificação</label>
        <select id="classificacao" name="classificacao" onchange="filtrarCarretas()">
            <option value="">Selecione...</option>
            <option value="agregado" {% if cavalo and cavalo.classificacao == 'agregado' %}selected{% endif %}>Agregado</option>
            <option value="frota" {% if cavalo and cavalo.classificacao == 'frota' %}selected{% endif %}>Frota</option>
            <option value="terceiro" {% if cavalo and cavalo.classificacao == 'terceiro' %}selected{% endif %}>Terceiro</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="situacao">Situação</label>
        <select id="situacao" name="situacao">
            <option value="">Selecione...</option>
            <option value="ativo" {% if cavalo and cavalo.situacao == 'ativo' %}selected{% endif %}>Ativo</option>
            <option value="parado" {% if cavalo and cavalo.situacao == 'parado' %}selected{% endif %}>Parado</option>
            <option value="desagregado" {% if cavalo and cavalo.situacao == 'desagregado' %}selected{% endif %}>Desagregado</option>
        </select>
    </div>
    
    <div class="form-group">
        <label for="proprietario">Proprietário</label>
        <select id="proprietario" name="proprietario">
            <option value="">Selecione...</option>
            {% for proprietario in proprietarios %}
            <option value="{{ proprietario.pk }}" 
                    {% if cavalo and cavalo.proprietario.pk == proprietario.pk %}selected{% endif %}>
                {{ proprietario.nome_razao_social }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label for="gestor">Gestor</label>
        <select id="gestor" name="gestor">
            <option value="">Selecione...</option>
            {% for gestor in gestores %}
            <option value="{{ gestor.pk }}" 
                    {% if cavalo and cavalo.gestor and cavalo.gestor.pk == gestor.pk %}selected{% endif %}>
                {{ gestor.nome }}
            </option>
            {% endfor %}
        </select>
    </div>
    
    <div class="form-group">
        <label for="motorista">Motorista</label>
        <select id="motorista" name="motorista">
            <option value="">Selecione...</option>
            {% for motorista in motoristas %}
            <option value="{{ motorista.pk }}" 
                    {% if cavalo and cavalo.motorista and cavalo.motorista.pk == motorista.pk %}selected{% endif %}>
                {{ motorista.nome }}{% if motorista.cpf %} - {{ motorista.cpf }}{% endif %}
            </option>
            {% endfor %}
        </select>
        <p style="margin-top: 0.5rem; color: #7f8c8d; font-size: 0.875rem;">
            Selecione um motorista para associar a este cavalo. Se o motorista já estiver associado a outro cavalo, a associação anterior será removida.
        </p>
    </div>
    
    <div class="form-group">
        <label for="carreta">Carreta Agregada</label>
        <select id="carreta" name="carreta">
            <option value="">Nenhuma</option>
            <option value="s_placa" id="opcao_s_placa" 
                    {% if cavalo and cavalo.tipo == 'bi_truck' and not cavalo.carreta %}selected{% endif %}>
                S/Placa
            </option>
            {% for carreta in carretas_disponiveis %}
            <option value="{{ carreta.pk }}" 
                    data-classificacao="{{ carreta.classificacao|default:'' }}"
                    {% if cavalo and cavalo.carreta and cavalo.carreta.pk == carreta.pk %}selected{% endif %}>
                {{ carreta.placa }} 
                {% if carreta.classificacao %}({{ carreta.get_classificacao_display }}){% endif %}
                {% if not carreta.disponivel %}(Já acoplada){% endif %}
            </option>
            {% endfor %}
        </select>
        <p style="margin-top: 0.5rem; color: #7f8c8d; font-size: 0.875rem;">
            Apenas carretas disponíveis e compatíveis com a classificação do cavalo são mostradas aqui.
        </p>
    </div>
    
    <script>
        function filtrarCarretas() {
            var tipoCavalo = document.getElementById('tipo').value;
            var classificacaoCavalo = document.getElementById('classificacao').value;
            var selectCarreta = document.getElementById('carreta');
            var options = selectCarreta.getElementsByTagName('option');
            var selectedValue = selectCarreta.value;
            var selectedOptionHidden = false;
            var hasVisibleOptions = false;
            var opcaoSPlaca = document.getElementById('opcao_s_placa');
            
            // Se for Bi-truck, mostrar apenas "S/Placa" e "Nenhuma", ocultar todas as carretas
            if (tipoCavalo === 'bi_truck') {
                // Se não tem "S/Placa" selecionado, selecionar automaticamente
                if (selectedValue !== 's_placa' && selectedValue !== '') {
                    selectCarreta.value = 's_placa';
                }
                
                for (var i = 0; i < options.length; i++) {
                    var option = options[i];
                    if (option.value === '' || option.value === 's_placa') {
                        // Mostrar "Nenhuma" e "S/Placa"
                        option.style.display = '';
                        hasVisibleOptions = true;
                    } else {
                        // Ocultar todas as carretas reais
                        option.style.display = 'none';
                        if (option.value === selectedValue) {
                            selectedOptionHidden = true;
                        }
                    }
                }
            } else {
                // Se não for Bi-truck, ocultar "S/Placa" e mostrar carretas normalmente
                if (opcaoSPlaca) {
                    opcaoSPlaca.style.display = 'none';
                    // Se "S/Placa" estava selecionado, limpar seleção
                    if (selectedValue === 's_placa') {
                        selectCarreta.value = '';
                        selectedValue = '';
                    }
                }
                
                // Mapeamento de classificação: cavalo -> carreta
                var classificacaoMap = {
                    'agregado': 'agregado',
                    'frota': 'frota',
                    'terceiro': 'terceiro'
                };
                
                // Determinar qual classificação de carreta é compatível
                var classificacaoCarretaEsperada = classificacaoMap[classificacaoCavalo] || null;
                
                // Mostrar/ocultar opções baseado na classificação
                for (var i = 0; i < options.length; i++) {
                    var option = options[i];
                    if (option.value === '' || option.value === 's_placa') {
                        // Sempre mostrar opção "Nenhuma", ocultar "S/Placa" se não for bi-truck
                        if (option.value === '') {
                            option.style.display = '';
                            hasVisibleOptions = true;
                        } else {
                            option.style.display = 'none';
                        }
                    } else {
                        var classificacaoCarreta = option.getAttribute('data-classificacao');
                        
                        // Se não tem classificação do cavalo selecionada, ocultar todas as carretas
                        if (!classificacaoCavalo) {
                            option.style.display = 'none';
                            if (option.value === selectedValue) {
                                selectedOptionHidden = true;
                            }
                        } else {
                            // Se tem classificação, mostrar apenas carretas compatíveis
                            if (classificacaoCarreta === classificacaoCarretaEsperada) {
                                option.style.display = '';
                                hasVisibleOptions = true;
                            } else {
                                option.style.display = 'none';
                                if (option.value === selectedValue) {
                                    selectedOptionHidden = true;
                                }
                            }
                        }
                    }
                }
            }
            
            // Se a opção selecionada foi ocultada, limpar seleção
            if (selectedOptionHidden) {
                selectCarreta.value = '';
            }
            
            // Se não há opções visíveis (além de "Nenhuma" ou "S/Placa"), mostrar mensagem
            if (classificacaoCavalo && !hasVisibleOptions && tipoCavalo !== 'bi_truck') {
                var helpText = selectCarreta.parentElement.querySelector('.form-text');
                if (!helpText || !helpText.textContent.includes('Nenhuma carreta')) {
                    var newHelpText = document.createElement('small');
                    newHelpText.className = 'form-text text-warning d-block mt-1';
                    newHelpText.textContent = '⚠ Nenhuma carreta disponível para esta classificação.';
                    selectCarreta.parentElement.appendChild(newHelpText);
                }
            } else {
                var warningText = selectCarreta.parentElement.querySelector('.text-warning');
                if (warningText) {
                    warningText.remove();
                }
            }
        }
        
        // Adicionar listener para mudança de tipo e classificação
        document.addEventListener('DOMContentLoaded', function() {
            var tipoSelect = document.getElementById('tipo');
            var classificacaoSelect = document.getElementById('classificacao');
            
            if (tipoSelect) {
                tipoSelect.addEventListener('change', filtrarCarretas);
            }
            if (classificacaoSelect) {
                classificacaoSelect.addEventListener('change', filtrarCarretas);
            }
            
            // Executar filtro ao carregar a página
            filtrarCarretas();
        });
    </script>
    
    <div class="form-group">
        <label for="foto">Foto</label>
        <input type="file" id="foto" name="foto" accept="image/*">
        {% if cavalo and cavalo.foto %}
            <p style="margin-top: 0.5rem; color: #7f8c8d;">Foto atual: 
                <a href="{{ cavalo.foto.url }}" target="_blank">Ver</a>
            </p>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="documento">Documento</label>
        <input type="file" id="documento" name="documento">
        {% if cavalo and cavalo.documento %}
            <p style="margin-top: 0.5rem; color: #7f8c8d;">Documento atual: 
                <a href="{{ cavalo.documento.url }}" target="_blank">Ver</a>
            </p>
        {% endif %}
    </div>
    
    <div class="form-group">
        <label for="observacoes">Observações</label>
        <textarea id="observacoes" name="observacoes">{% if cavalo %}{{ cavalo.observacoes }}{% endif %}</textarea>
    </div>
    
    <div class="actions">
        <button type="submit" class="btn btn-success">Salvar</button>
        <a href="{% if cavalo %}{% url 'cavalo_detail' cavalo.pk %}{% else %}{% url 'cavalo_list' %}{% endif %}" 
           class="btn btn-secondary">Cancelar</a>
    </div>
</form>
{% endblock %}

